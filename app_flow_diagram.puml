@startuml
!define RECTANGLE class
!theme plain

title Doctor App - Complete System Flow

skinparam backgroundColor #F8F9FA
skinparam handwritten false
skinparam monochrome false

' Color scheme
skinparam component {
    BackgroundColor #E3F2FD
    BorderColor #1976D2
}

skinparam database {
    BackgroundColor #F3E5F5
    BorderColor #7B1FA2
}

skinparam cloud {
    BackgroundColor #E8F5E8
    BorderColor #388E3C
}

' External Services
cloud "Firebase Auth" as FirebaseAuth
cloud "Supabase Database" as SupabaseDB
cloud "Supabase Storage" as SupabaseStorage
cloud "Twilio WhatsApp" as TwilioWA
cloud "Google Gemini AI" as GeminiAI

' Main Application Components
component "FastAPI App\n(app.py)" as MainApp {
    component "Authentication\nEndpoints" as AuthEndpoints
    component "Patient Management\nEndpoints" as PatientEndpoints
    component "Visit Management\nEndpoints" as VisitEndpoints
    component "Report Management\nEndpoints" as ReportEndpoints
    component "Lab Management\nEndpoints" as LabEndpoints
    component "AI Analysis\nEndpoints" as AIEndpoints
    component "PDF & Templates\nEndpoints" as PDFEndpoints
    component "WhatsApp\nEndpoints" as WhatsAppEndpoints
    component "Calendar\nEndpoints" as CalendarEndpoints
    component "Billing\nEndpoints" as BillingEndpoints
    component "Notification\nEndpoints" as NotificationEndpoints
}

' Service Classes
component "DatabaseManager\n(database.py)" as DBManager
component "WhatsAppService\n(whatsapp_service.py)" as WAService
component "Firebase Manager\n(firebase_manager.py)" as FBManager
component "AI Analysis Service\n(ai_analysis_service.py)" as AIService
component "AI Analysis Processor\n(ai_analysis_processor.py)" as AIProcessor
component "PDF Generator\n(pdf_generator.py)" as PDFGen
component "Visit Report Generator\n(visit_report_generator.py)" as VisitReportGen

' Lab Portal Components
component "Lab Portal\n(Templates)" as LabPortal {
    component "Lab Login Page\n(lab_login.html)" as LabLogin
    component "Lab Dashboard\n(lab_dashboard.html)" as LabDashboard
    component "Lab Upload Page\n(lab_upload.html)" as LabUpload
}

' Patient Upload Portal
component "Patient Upload Portal" as PatientPortal {
    component "Report Upload Page" as ReportUpload
}

' Data Models/Tables (in Supabase)
database "Core Tables" as CoreTables {
    database "doctors" as DoctorsTable
    database "patients" as PatientsTable
    database "visits" as VisitsTable
    database "reports" as ReportsTable
    database "pdf_templates" as PDFTemplatesTable
    database "handwritten_visit_notes" as HandwrittenNotesTable
    database "visit_reports" as VisitReportsTable
}

database "AI & Analysis Tables" as AITables {
    database "ai_analysis_results" as AIResultsTable
    database "consolidated_analysis_results" as ConsolidatedTable
    database "patient_history_analyses" as PatientHistoryTable
    database "ai_analysis_queue" as AIQueueTable
}

database "Lab & Communication Tables" as LabTables {
    database "lab_contacts" as LabContactsTable
    database "lab_report_requests" as LabRequestsTable
    database "report_upload_links" as UploadLinksTable
    database "notifications" as NotificationsTable
}

' External User Types
actor "Doctor\n(Mobile/Web App)" as Doctor
actor "Patient\n(WhatsApp/Upload Portal)" as Patient
actor "Lab Technician\n(Lab Portal)" as LabTech

' DOCTOR WORKFLOW
Doctor --> AuthEndpoints : 1. Register/Login\n(Firebase Auth)
AuthEndpoints --> FBManager : Verify Token
FBManager --> FirebaseAuth : Validate User
FirebaseAuth --> FBManager : User Details
FBManager --> AuthEndpoints : Validated User
AuthEndpoints --> DBManager : Store/Fetch Doctor Profile
DBManager --> SupabaseDB : CRUD Operations
SupabaseDB --> DoctorsTable : Store Doctor Data

Doctor --> PatientEndpoints : 2. Manage Patients
PatientEndpoints --> DBManager : Patient CRUD
DBManager --> PatientsTable : Store Patient Data

Doctor --> VisitEndpoints : 3. Create Visit with Tests
VisitEndpoints --> DBManager : Create Visit
DBManager --> VisitsTable : Store Visit Data
VisitEndpoints --> DBManager : Auto-create Lab Requests
DBManager --> LabRequestsTable : Store Requests

Doctor --> ReportEndpoints : 4. Generate Upload Links
ReportEndpoints --> DBManager : Create Upload Token
DBManager --> UploadLinksTable : Store Upload Link
ReportEndpoints --> WhatsAppEndpoints : Send Link to Patient
WhatsAppEndpoints --> WAService : Send WhatsApp Message
WAService --> TwilioWA : Send Message to Patient

' PATIENT WORKFLOW
Patient --> PatientPortal : 5. Access Upload Link
PatientPortal --> ReportUpload : Upload Interface
ReportUpload --> ReportEndpoints : Upload Reports
ReportEndpoints --> SupabaseStorage : Store Files
ReportEndpoints --> DBManager : Save Report Records
DBManager --> ReportsTable : Store Report Data
ReportEndpoints --> DBManager : Queue AI Analysis
DBManager --> AIQueueTable : Queue Analysis
ReportEndpoints --> DBManager : Create Notification
DBManager --> NotificationsTable : Notify Doctor

' LAB TECHNICIAN WORKFLOW
LabTech --> LabPortal : 6. Access Lab Portal
LabPortal --> LabLogin : Phone-only Login
LabLogin --> LabEndpoints : Authenticate
LabEndpoints --> DBManager : Verify Lab Contact
DBManager --> LabContactsTable : Check Lab Data

LabTech --> LabDashboard : 7. View Requests
LabDashboard --> LabEndpoints : Get Pending Requests
LabEndpoints --> DBManager : Fetch Lab Requests
DBManager --> LabRequestsTable : Get Requests

LabTech --> LabUpload : 8. Upload Reports
LabUpload --> LabEndpoints : Submit Reports
LabEndpoints --> SupabaseStorage : Store Lab Files
LabEndpoints --> DBManager : Save to Reports Table
DBManager --> ReportsTable : Store Report Data
LabEndpoints --> DBManager : Update Request Status
DBManager --> LabRequestsTable : Mark Completed

' AI ANALYSIS WORKFLOW
AIProcessor --> DBManager : 9. Background Processing
DBManager --> AIQueueTable : Get Pending Analyses
AIProcessor --> AIService : Process Documents
AIService --> GeminiAI : Analyze with Context
GeminiAI --> AIService : Analysis Results
AIService --> AIProcessor : Structured Results
AIProcessor --> DBManager : Save AI Results
DBManager --> AIResultsTable : Store Analysis

Doctor --> AIEndpoints : 10. View AI Analysis
AIEndpoints --> DBManager : Fetch Analysis
DBManager --> AIResultsTable : Get Results

Doctor --> AIEndpoints : 11. Patient History Analysis
AIEndpoints --> AIService : Comprehensive Analysis
AIService --> GeminiAI : Analyze Complete History
AIService --> DBManager : Save History Analysis
DBManager --> PatientHistoryTable : Store Analysis

' PDF & DOCUMENT GENERATION
Doctor --> PDFEndpoints : 12. Manage Templates
PDFEndpoints --> SupabaseStorage : Store PDF Templates
PDFEndpoints --> DBManager : Save Template Data
DBManager --> PDFTemplatesTable : Store Template Info

Doctor --> VisitEndpoints : 13. Handwritten Notes
VisitEndpoints --> DBManager : Select Template
VisitEndpoints --> PDFEndpoints : Upload Handwritten PDF
PDFEndpoints --> SupabaseStorage : Store Handwritten Notes
PDFEndpoints --> DBManager : Save Note Record
DBManager --> HandwrittenNotesTable : Store Note Data

Doctor --> PDFEndpoints : 14. Generate Visit Reports
PDFEndpoints --> VisitReportGen : Create Custom Report
VisitReportGen --> PDFGen : Generate PDF
PDFGen --> PDFEndpoints : PDF Content
PDFEndpoints --> SupabaseStorage : Store Report PDF
PDFEndpoints --> DBManager : Save Report Record
DBManager --> VisitReportsTable : Store Report Data
PDFEndpoints --> WhatsAppEndpoints : Send to Patient
WhatsAppEndpoints --> WAService : Send WhatsApp
WAService --> TwilioWA : Deliver PDF Link

' CALENDAR & BILLING
Doctor --> CalendarEndpoints : 15. Manage Appointments
CalendarEndpoints --> DBManager : Follow-up Scheduling
DBManager --> VisitsTable : Update Follow-up Dates

Doctor --> BillingEndpoints : 16. Billing Management
BillingEndpoints --> DBManager : Update Payment Status
DBManager --> VisitsTable : Store Billing Info

' NOTIFICATIONS
DBManager --> NotificationEndpoints : 17. Real-time Notifications
NotificationEndpoints --> DBManager : Fetch Notifications
DBManager --> NotificationsTable : Get Unread Notifications

' DATA FLOW LEGEND
note right of MainApp
    Main Components:
    • FastAPI application with 11 endpoint groups
    • 7 service classes for business logic
    • 3 UI portals (Doctor, Patient, Lab)
    • 15+ database tables in Supabase
    • 4 external services integration
end note

note right of CoreTables
    Core Data Flow:
    1. Doctor registers & manages patients
    2. Creates visits with test recommendations
    3. Auto-generates lab requests
    4. Patients/Labs upload reports
    5. AI analyzes reports automatically
    6. Doctor reviews AI insights
    7. Generates custom reports
    8. Sends via WhatsApp
end note

note right of AITables
    AI Analysis Features:
    • Document analysis with patient context
    • Consolidated multi-report analysis
    • Comprehensive patient history analysis
    • Background processing queue
    • Confidence scoring and error handling
end note

note right of LabTables
    Lab Integration:
    • Profile-based lab contacts
    • Automated request generation
    • Token-based secure uploads
    • Status tracking and notifications
    • WhatsApp communication
end note

' Styling for better visibility
skinparam note {
    BackgroundColor #FFF3E0
    BorderColor #F57C00
}

@enduml
